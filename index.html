<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONALIA DIAGNOSTIC</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; color: #00ff00; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #debug-console {
            position: absolute; top: 0; left: 0; width: 400px; height: 100%;
            background: rgba(0,0,0,0.8); padding: 20px; z-index: 100;
            pointer-events: none; overflow-y: auto; border-right: 1px solid #00ff00;
            font-size: 12px; line-height: 1.4;
        }
        .log-item { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .error { color: #ff3333; font-weight: bold; background: #220000; }
        .success { color: #00ffff; }
        
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r120/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.120.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="debug-console">
        <div id="logs">SONALIA DIAGNOSTIC TOOL v1.0<br>---------------------------<br></div>
    </div>
    
    <div id="hud-layer">
        <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:#fff;">
            SYSTEM DIAGNOSIS RUNNING...
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- DEBUGGER ---
        function log(msg, type="") {
            const div = document.getElementById('logs');
            const item = document.createElement('div');
            item.className = "log-item " + type;
            item.innerText = `> ${msg}`;
            div.appendChild(item);
            console.log(msg);
        }

        window.onerror = function(msg, url, line) {
            log(`CRITICAL ERROR: ${msg} (Line: ${line})`, "error");
            return false;
        };

        // --- MAIN VARIABLES ---
        let scene, camera, renderer, controls, mainGroup;
        let glowTex;

        // --- INITIALIZATION ---
        try {
            log("Step 1: Checking Libraries...");
            if (typeof THREE === 'undefined') throw new Error("Three.js not loaded");
            if (typeof THREE.OrbitControls === 'undefined') throw new Error("OrbitControls not loaded");
            log("Libraries OK.", "success");

            log("Step 2: Initializing Scene...");
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.001);

            // 軸表示 (赤=X, 緑=Y, 青=Z)
            const axesHelper = new THREE.AxesHelper(500);
            scene.add(axesHelper);
            log("Debug Axes Added (Red/Green/Blue).");

            camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 5000);
            camera.position.set(300, 150, 300);
            camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true, canvas: document.getElementById('canvas') });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.0; // 早めに回して確認
            log("Renderer & Camera OK.", "success");

            mainGroup = new THREE.Group();
            // 診断のため、あえて回転させずに素の状態で表示
            // mainGroup.rotation.z = -Math.PI / 2; 
            scene.add(mainGroup);

            // テクスチャ生成テスト
            log("Step 3: Generating Textures...");
            glowTex = createGlowTex();
            if(!glowTex) throw new Error("Texture generation failed");
            log("Texture Generated.", "success");

            // オブジェクト生成
            log("Step 4: Building Objects...");
            buildTestObjects();
            log("Objects Built.", "success");

            // アニメーション開始
            log("Step 5: Starting Animation Loop...");
            animate();
            log("Animation Loop Started.", "success");

        } catch(e) {
            log(e.message, "error");
        }

        // --- FUNCTIONS ---

        function createGlowTex() {
            try {
                const c = document.createElement('canvas'); c.width=64; c.height=64;
                const ctx = c.getContext('2d');
                const g = ctx.createRadialGradient(32,32,0, 32,32,32);
                g.addColorStop(0, 'white');
                g.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
                return new THREE.CanvasTexture(c);
            } catch(e) {
                log("Tex Error: " + e.message, "error");
                return null;
            }
        }

        function buildTestObjects() {
            // 1. OS (Diamond)
            const osGeo = new THREE.OctahedronGeometry(50, 0);
            const osMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
            const os = new THREE.Mesh(osGeo, osMat);
            os.position.set(-100, 0, 0);
            mainGroup.add(os);
            log("Added: OS (Diamond)");

            // 2. DB (Sphere)
            const dbGeo = new THREE.SphereGeometry(30, 16, 16);
            const dbMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
            const db = new THREE.Mesh(dbGeo, dbMat);
            db.position.set(0, 0, 0);
            mainGroup.add(db);
            log("Added: DB (Sphere)");

            // 3. Factor (Cubes around)
            for(let i=0; i<8; i++) {
                const box = new THREE.Mesh(
                    new THREE.BoxGeometry(10,10,10),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true })
                );
                const ang = (i/8) * Math.PI * 2;
                box.position.set(100 + Math.cos(ang)*50, Math.sin(ang)*50, 0);
                mainGroup.add(box);
            }
            log("Added: 8 Factors (Cubes)");

            // 4. Particles
            const pGeo = new THREE.Geometry();
            for(let i=0; i<100; i++) {
                pGeo.vertices.push(new THREE.Vector3(
                    (Math.random()-0.5)*300,
                    (Math.random()-0.5)*100,
                    (Math.random()-0.5)*100
                ));
            }
            const pMat = new THREE.PointsMaterial({ color: 0xffffff, size: 2, map: glowTex, transparent: true, blending: THREE.AdditiveBlending, depthWrite:false });
            const parts = new THREE.Points(pGeo, pMat);
            mainGroup.add(parts);
            log("Added: Particles");
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
